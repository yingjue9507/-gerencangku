# 心流AI多窗网页浏览器 - 开发需求文档

## 项目概述
心流AI多窗网页浏览器是一个基于Electron的桌面应用程序，支持多窗口浏览、AI集成等功能。

## 功能需求列表

### 1. 启动脚本优化 ✅
**需求描述：** 解决批处理文件编码问题和控制台乱码问题
**实现状态：** 已完成
**实现日期：** 2024年12月

**详细说明：**
- 修复了批处理文件的编码问题，解决双击后立即退出的问题
- 将应用内所有中文日志改为英文，解决Windows控制台乱码问题
- 创建了多种启动方式：
  - `启动.bat` - 标准启动脚本
  - `启动-调试版.bat` - 包含调试信息的启动脚本
  - `启动.ps1` - PowerShell启动脚本
  - `安装依赖.bat` - 依赖检查和安装脚本

**技术实现：**
- 重新创建批处理文件，使用英文提示信息
- 修改 `src/main/main.js` 中的所有 `console.log` 输出为英文
- 添加错误处理和调试信息
- 支持UTF-8编码显示

**用户体验改进：**
- 启动时显示清晰的英文日志信息
- 解决了控制台乱码问题
- 提供多种启动方式满足不同用户需求
- 增强了错误提示和调试信息

### 2. 多窗口管理功能 ✅
**需求描述：** 支持多窗口浏览和窗口管理
**实现状态：** 已完成

**功能特性：**
- 主窗口创建和管理
- 弹出窗口自动管理
- 窗口缩放功能（Ctrl+鼠标滚轮）
- 窗口自动收回功能
- OAuth弹窗特殊处理

### 3. JavaScript文件引用修复 ✅
**需求描述：** 修复HTML文件中缺失的JavaScript文件引用，解决左侧AI服务列表和设置按钮无响应问题
**实现状态：** 已完成
**实现日期：** 2024年12月

**问题描述：**
- 左侧AI服务列表无法显示
- 设置按钮点击无响应
- 应用程序功能不完整

**根本原因：**
- `index.html` 文件中只引用了 `app.js`，缺少其他关键JavaScript文件
- 缺少设置管理器、设置UI、通知系统等核心模块的引用

**技术实现：**
- 在 `index.html` 中添加了所有必需的JavaScript文件引用：
  - `error-handler.js` - 错误处理系统
  - `notification-system.js` - 通知系统
  - `validation-system.js` - 验证系统
  - `security-manager.js` - 安全管理器
  - `memory-optimizer.js` - 内存优化器
  - `performance-monitor.js` - 性能监控器
  - `resource-optimizer.js` - 资源优化器
  - `settings-manager.js` - 设置管理器
  - `settings-ui.js` - 设置界面
  - `app.js` - 主应用程序

**修复效果：**
- 左侧AI服务列表正常显示和工作
- 设置按钮响应正常
- 所有核心功能模块正常加载
- 应用程序完整功能恢复

**调试改进：**
- 在主进程中添加了渲染进程控制台消息监听器
- 便于实时查看JavaScript错误和调试信息
- 提升了开发和维护效率

### 4. 会话管理功能 ✅
**需求描述：** 支持独立的浏览会话管理
**实现状态：** 已完成

**功能特性：**
- 分区会话管理
- 会话数据清理
- Cookie和缓存管理
- 独立的浏览环境

## 已完成功能需求

### 4. AI服务管理增强 ✅
**需求描述：** 改进服务删除功能UI，新增中国常用AI服务，实现用户高度自由的服务管理
**实现状态：** 已完成
**实现日期：** 2024年12月

**详细说明：**
- 改进右键菜单删除选项的视觉效果，使用红色高亮显示
- 增强删除确认对话框，提供更详细的警告信息
- 添加错误处理和成功通知机制
- 新增5个中国常用AI服务：通义千问、文心一言、豆包、Kimi、智谱清言
- **重要变更**：允许删除所有服务，包括默认AI服务，移除删除限制

**技术实现：**
- 修改右键菜单样式，删除选项使用红色背景和白色文字
- 优化删除确认对话框的文案和样式
- 完善错误处理机制和用户反馈
- 扩展AI服务配置，支持更多国内AI平台
- 移除对默认服务的删除保护，实现完全自由的服务管理

**用户体验改进：**
- 更直观的删除操作体验，减少误操作
- 支持更多中国本土AI服务，满足国内用户需求
- 更好的错误处理和用户反馈
- **完全自由的服务管理**：用户可删除任何服务，拥有完全控制权

### 5. UI界面优化 ✅
**需求描述：** 优化应用界面的视觉效果和用户体验
**实现状态：** 已完成
**实现日期：** 2024年12月

**详细说明：**
- 将AI应用设置的背景颜色改为浅蓝色系渐变
- 提升界面的视觉舒适度和现代感
- 保持与整体设计风格的一致性

**技术实现：**
- 修改 `index.html` 中的 `body` 样式
- 使用CSS渐变背景：`linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%)`
- 从原有的紫色系渐变更新为清新的浅蓝色系

**用户体验改进：**
- 更加清新舒适的视觉体验
- 减少视觉疲劳，提升长时间使用的舒适度
- 符合现代应用设计趋势

### 6. 无痕模式功能 ✅
**需求描述：** 为AI服务增加无痕模式，关闭后自动删除所有浏览和登录痕迹
**实现状态：** 已完成
**实现日期：** 2024年12月

**详细说明：**
- 在添加和编辑AI服务时提供无痕模式选项
- 无痕模式下使用临时分区，不保存任何浏览数据
- 关闭服务时自动清理所有会话数据和登录信息
- 提供清晰的用户反馈和状态提示

**技术实现：**
- 在服务配置中添加 `incognitoMode` 布尔字段
- 修改 `webview` 创建逻辑，无痕模式使用临时分区ID
- 实现 `clearIncognitoData` 方法清理会话数据
- 支持清理cookies、localStorage、缓存等所有浏览痕迹
- 在关闭时显示数据清理状态通知

**功能特性：**
- **临时分区**：无痕模式使用 `incognito-${serviceId}-${timestamp}` 格式的临时分区
- **数据隔离**：与普通模式完全隔离，不影响其他服务
- **自动清理**：关闭时自动清理所有存储数据（cookies、localStorage、缓存等）
- **用户反馈**：清晰的状态提示和操作反馈
- **安全性**：确保无痕模式下的数据不会泄露或保留

**用户体验改进：**
- 提供隐私保护选项，满足用户对数据安全的需求
- 简单易用的开关设计，用户可自由选择
- 清晰的状态反馈，用户了解数据清理状态
- 支持临时使用AI服务而不留下任何痕迹

### 7. 健康检查错误优化 ✅
**需求描述：** 优化健康检查错误的显示格式和去重逻辑，解决重复警告问题
**实现状态：** 已完成
**实现日期：** 2025年1月1日

**问题描述：**
- 健康检查警告显示为 `[object Object]`，信息不可读
- 健康检查警告频繁重复出现，影响用户体验
- 错误去重机制对健康检查类型错误不够有效

**根本原因：**
- `formatHealthSummary` 方法返回对象而非字符串，导致显示异常
- 健康检查错误使用通用去重逻辑，时间窗口和频率控制不合适
- 错误键生成机制对健康检查类型缺乏特殊处理

**技术实现：**
- **错误格式化修复** (`src/renderer/error-handler.js`)：
  - 修复 `formatHealthSummary` 方法，确保返回格式化字符串
  - 优化健康摘要信息的显示格式，包含状态、问题详情和建议
  - 添加空值检查和错误处理机制

- **错误键生成优化**：
  - 在 `generateErrorKey` 方法中为健康检查错误添加特殊处理
  - 健康检查错误使用 `health_check:${source}` 格式的错误键
  - 提供更精确的去重支持

- **去重逻辑增强**：
  - 在 `isDuplicateError` 方法中为健康检查错误设置专门的去重参数
  - 健康检查错误使用更长的去重时间窗口（30秒 vs 5秒）
  - 减少健康检查错误的最大通知次数（1次 vs 3次）
  - 避免频繁的重复健康检查警告

**功能特性：**
- **智能格式化**：健康检查信息以可读格式显示，包含状态、问题和建议
- **精确去重**：针对健康检查错误的专门去重逻辑
- **频率控制**：30秒内同类健康检查错误只显示一次
- **用户友好**：减少重复警告，提升用户体验

**修复效果：**
- 健康检查警告信息清晰可读，不再显示 `[object Object]`
- 重复健康检查警告得到有效控制
- 保持重要健康信息的及时提醒，同时避免过度干扰
- 提升应用程序的整体用户体验

**用户体验改进：**
- 清晰的健康状态信息显示
- 减少重复警告的干扰
- 保持重要健康提醒的有效性
- 提供更好的应用程序监控体验

## 待开发功能

### 5. AI集成功能
**需求描述：** 集成AI助手功能
**优先级：** 高
**预期功能：**
- AI对话界面
- 网页内容AI分析
- 智能搜索建议
- AI辅助浏览

### 5. 书签管理
**需求描述：** 完善的书签管理系统
**优先级：** 中
**预期功能：**
- 书签添加/删除/编辑
- 书签分类管理
- 书签导入/导出
- 书签同步

### 6. 历史记录
**需求描述：** 浏览历史记录管理
**优先级：** 中
**预期功能：**
- 历史记录查看
- 历史记录搜索
- 历史记录清理
- 访问频率统计

### 7. 扩展支持
**需求描述：** 支持浏览器扩展
**优先级：** 低
**预期功能：**
- 扩展安装/卸载
- 扩展管理界面
- 常用扩展预装
- 扩展权限管理

## 技术架构

### 主要技术栈
- **前端框架：** Electron
- **主进程：** Node.js
- **渲染进程：** HTML/CSS/JavaScript
- **包管理：** npm

### 项目结构
```
src/
├── main/           # 主进程代码
│   └── main.js     # 主进程入口文件
├── renderer/       # 渲染进程代码
│   └── index.html  # 主界面
└── adapters/       # 适配器模块
```

## 版本历史

### v1.2.1 (2024年12月)
- **新增功能**：
  - 错误通知去重系统：智能过滤重复错误通知，提升用户体验
  - 错误处理优化：修复SecurityManager方法调用错误
- **功能特性**：
  - 错误去重机制：在5秒时间窗口内自动过滤相同类型的重复错误
  - 错误频率限制：同类型错误通知最多显示3次，避免通知轰炸
  - 自动清理机制：定期清理过期的错误记录，防止内存泄漏
  - 智能错误分类：基于错误类型、消息和来源生成唯一标识
- **技术实现**：
  - 在`error-handler.js`中新增`isDuplicateError`和`generateErrorKey`方法
  - 使用Map数据结构存储错误记录，支持高效查找和清理
  - 修复`app.js`中`injectAntiDetectionScripts`方法名错误
- **用户体验提升**：
  - 显著减少重复错误通知的干扰
  - 保持重要错误的及时提醒功能
  - 提升应用程序运行的稳定性和流畅度

### v1.2.0 (2024年12月)
- **新增功能**：
  - UI界面优化：将应用背景改为清新的浅蓝色系渐变
  - 无痕模式功能：为AI服务增加隐私保护选项
- **功能特性**：
  - 无痕模式使用临时分区，关闭后自动清理所有浏览痕迹
  - 支持cookies、localStorage、缓存等全面数据清理
  - 提供清晰的状态反馈和操作提示
- **用户体验提升**：
  - 更舒适的视觉体验，减少长时间使用的疲劳
  - 增强隐私保护，满足用户对数据安全的需求
  - 简单易用的无痕模式开关设计

### v1.1.1 (2024年12月)
- **重要功能变更**：移除默认服务删除限制，实现用户高度自由管理
- **服务管理自由化**：所有AI服务（包括默认服务）均可删除
- **用户体验提升**：用户拥有完全的服务管理控制权
- **代码优化**：简化删除逻辑，移除服务类型判断限制

### v1.1.0 (2024年12月)
- **新增功能**:
  - 改进AI服务删除功能UI，使用红色高亮显示删除选项
  - 增强删除确认对话框，提供详细警告信息和错误处理
  - 新增5个中国常用AI服务：通义千问、文心一言、豆包、Kimi、智谱清言
- **用户体验优化**:
  - 更直观的删除操作体验，减少误操作风险
  - 支持更多中国本土AI服务，满足国内用户需求
  - 完善的错误处理和用户反馈机制

### 8. 启动错误处理优化 ✅
**需求描述：** 解决应用启动时出现的早期错误提示框问题
**实现状态：** 已完成
**实现日期：** 2025年1月

**问题描述：**
- 应用启动时在初始化完成前会弹出多个健康检查错误提示框
- 错误处理器过早初始化，在应用完全准备好之前就开始执行健康检查
- 影响用户体验，虽然不影响功能使用

**技术实现：**
- **错误处理器优化** (`src/renderer/error-handler.js`):
  - 新增应用初始化状态跟踪机制
  - 添加 `appInitialized`、`pendingHealthAlerts` 等状态属性
  - 实现 `waitForAppInitialization()` 方法监听初始化完成事件
  - 修改 `checkHealthIfNeeded()` 方法，在初始化期间延迟非关键错误通知

- **性能监控器优化** (`src/renderer/performance-monitor.js`):
  - 修改自动启动逻辑，等待应用初始化完成后再开始监控
  - 避免在应用准备好之前触发内存泄漏检测警告
  - 实现 `startPerformanceMonitoringWhenReady()` 方法监听初始化事件

- **应用初始化流程优化** (`src/renderer/app.js`):
  - 在应用初始化完成时触发 `appInitialized` 自定义事件
  - 设置 `window.appInitialized` 全局标志
  - 确保所有监控系统在应用完全准备好后才开始正常工作

**用户体验改进：**
- 消除启动时的早期错误提示框干扰
- 保持错误处理功能的完整性，只是调整了时机
- 提升应用启动的专业性和用户体验

### v1.2.3 (2025年1月)
- **新增功能**：
  - 启动脚本优化系统：提供多种启动方式，解决cmd窗口持续显示问题
  - 完全静默启动：使用VBS脚本实现无窗口启动体验
- **功能特性**：
  - 多种启动方式：标准启动、完全静默启动、PowerShell启动、最小化启动
  - 智能窗口管理：自动关闭启动用的cmd窗口，应用在后台独立运行
  - 用户友好体验：提供启动方式说明文档，支持创建桌面快捷方式
- **技术实现**：
  - 修改`启动.bat`：使用start命令在新窗口启动应用，原窗口自动关闭
  - 创建`启动-完全静默.vbs`：使用VBScript实现完全无窗口启动
  - 创建`启动-静默.ps1`：使用PowerShell实现静默启动
  - 创建`启动方式说明.md`：详细说明各种启动方式的特点和使用场景
- **用户体验改进**：
  - 消除cmd窗口持续显示的问题
  - 提供多种启动方式满足不同需求
  - 支持完全静默的后台启动
  - 简化日常使用流程

### v1.2.2 (2025年1月)
- **新增功能**：
  - 启动通知优化系统：智能管理应用启动期间的错误通知，提升用户体验
  - 健康检查阈值动态调整：根据应用启动状态自动调整监控阈值
- **功能特性**：
  - 启动宽限期机制：应用启动后60秒内禁用非关键错误通知
  - 动态阈值调整：启动期间错误率、内存使用、系统资源检查使用更宽松的阈值
  - 智能通知过滤：只有关键错误在启动期间才会显示通知
  - 健康检查优化：启动期间暂停健康检查警告，避免误报
- **技术实现**：
  - 在`error-handler.js`中新增`startupGracePeriod`属性（60秒宽限期）
  - 修改`checkHealthIfNeeded`、`showHealthAlert`、`notifyUser`方法添加启动期间检查
  - 优化`checkErrorRate`方法：启动期间critical阈值从50提高到100，warning阈值从20提高到50
  - 优化`checkMemoryUsage`方法：启动期间critical阈值从90%提高到95%，warning阈值从75%提高到85%
  - 优化`checkSystemResources`方法：启动期间DOM节点阈值从10000提高到15000，事件监听器阈值从100提高到150
- **用户体验改进**：
  - 彻底解决启动时右上角持续弹出错误提示框的问题
  - 保持错误监控功能的完整性，只在启动稳定后才显示必要警告
  - 提升应用启动的专业性和流畅度
  - 减少用户在启动过程中的干扰和困惑

### v1.0.0 (当前版本)
- 基础多窗口浏览功能
- 启动脚本优化
- 会话管理功能
- 窗口管理功能

## 开发规范

### 代码规范
- 使用英文注释和日志信息
- 遵循JavaScript ES6+标准
- 统一的错误处理机制
- 完善的日志记录

### 文档规范
- 每个新功能都需要更新此需求文档
- 保持README.md和使用说明.txt的同步更新
- 记录重要的技术决策和实现细节

---
*最后更新：2025年1月1日*